(function(){"use strict";const k=()=>new Promise(n=>setTimeout(n)),I=n=>{let t=1;for(const e of n)e.vary&&(t*=Math.max(1,e.max_count-e.min_count+1));return t};let _;const L=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0});L.decode();let h=new Uint8Array;function d(){return h.byteLength===0&&(h=new Uint8Array(_.memory.buffer)),h}function w(n,t){return L.decode(d().subarray(n,n+t))}const b=new Array(32).fill(void 0);b.push(void 0,null,!0,!1);let m=b.length;function c(n){m===b.length&&b.push(b.length+1);const t=m;return m=b[t],b[t]=n,t}function i(n){return b[n]}let p=0;const v=new TextEncoder("utf-8"),W=typeof v.encodeInto=="function"?function(n,t){return v.encodeInto(n,t)}:function(n,t){const e=v.encode(n);return t.set(e),{read:n.length,written:e.length}};function E(n,t,e){if(e===void 0){const f=v.encode(n),u=t(f.length);return d().subarray(u,u+f.length).set(f),p=f.length,u}let r=n.length,o=t(r);const a=d();let s=0;for(;s<r;s++){const f=n.charCodeAt(s);if(f>127)break;a[o+s]=f}if(s!==r){s!==0&&(n=n.slice(s)),o=e(o,r,r=s+n.length*3);const f=d().subarray(o+s,o+r);s+=W(n,f).written}return p=s,o}let S=new Int32Array;function l(){return S.byteLength===0&&(S=new Int32Array(_.memory.buffer)),S}function F(n){n<36||(b[n]=m,m=n)}function M(n){const t=i(n);return F(n),t}function x(n,t,e,r,o){try{const u=_.__wbindgen_add_to_stack_pointer(-16);_.simulate(u,n,c(t),c(e),r,o);var a=l()[u/4+0],s=l()[u/4+1],f=l()[u/4+2];if(f)throw M(s);return M(a)}finally{_.__wbindgen_add_to_stack_pointer(16)}}function g(n,t){try{return n.apply(this,t)}catch(e){_.__wbindgen_exn_store(c(e))}}function C(n,t){return d().subarray(n/1,n/1+t)}async function D(n,t){if(typeof Response=="function"&&n instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(n,t)}catch(r){if(n.headers.get("Content-Type")!="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",r);else throw r}const e=await n.arrayBuffer();return await WebAssembly.instantiate(e,t)}else{const e=await WebAssembly.instantiate(n,t);return e instanceof WebAssembly.Instance?{instance:e,module:n}:e}}function N(){const n={};return n.wbg={},n.wbg.__wbindgen_json_parse=function(t,e){const r=JSON.parse(w(t,e));return c(r)},n.wbg.__wbindgen_json_serialize=function(t,e){const r=i(e),o=JSON.stringify(r===void 0?null:r),a=E(o,_.__wbindgen_malloc,_.__wbindgen_realloc),s=p;l()[t/4+1]=s,l()[t/4+0]=a},n.wbg.__wbindgen_string_new=function(t,e){const r=w(t,e);return c(r)},n.wbg.__wbindgen_object_drop_ref=function(t){M(t)},n.wbg.__wbg_new_693216e109162396=function(){const t=new Error;return c(t)},n.wbg.__wbg_stack_0ddaca5d1abfb52f=function(t,e){const r=i(e).stack,o=E(r,_.__wbindgen_malloc,_.__wbindgen_realloc),a=p;l()[t/4+1]=a,l()[t/4+0]=o},n.wbg.__wbg_error_09919627ac0992f5=function(t,e){try{console.error(w(t,e))}finally{_.__wbindgen_free(t,e)}},n.wbg.__wbg_process_e56fd54cf6319b6c=function(t){const e=i(t).process;return c(e)},n.wbg.__wbindgen_is_object=function(t){const e=i(t);return typeof e=="object"&&e!==null},n.wbg.__wbg_versions_77e21455908dad33=function(t){const e=i(t).versions;return c(e)},n.wbg.__wbg_node_0dd25d832e4785d5=function(t){const e=i(t).node;return c(e)},n.wbg.__wbindgen_is_string=function(t){return typeof i(t)=="string"},n.wbg.__wbg_static_accessor_NODE_MODULE_26b231378c1be7dd=function(){const t=module;return c(t)},n.wbg.__wbg_require_0db1598d9ccecb30=function(){return g(function(t,e,r){const o=i(t).require(w(e,r));return c(o)},arguments)},n.wbg.__wbg_crypto_b95d7173266618a9=function(t){const e=i(t).crypto;return c(e)},n.wbg.__wbg_msCrypto_5a86d77a66230f81=function(t){const e=i(t).msCrypto;return c(e)},n.wbg.__wbg_getRandomValues_b14734aa289bc356=function(){return g(function(t,e){i(t).getRandomValues(i(e))},arguments)},n.wbg.__wbg_randomFillSync_91e2b39becca6147=function(){return g(function(t,e,r){i(t).randomFillSync(C(e,r))},arguments)},n.wbg.__wbg_newnoargs_971e9a5abe185139=function(t,e){const r=new Function(w(t,e));return c(r)},n.wbg.__wbg_call_33d7bcddbbfa394a=function(){return g(function(t,e){const r=i(t).call(i(e));return c(r)},arguments)},n.wbg.__wbindgen_object_clone_ref=function(t){const e=i(t);return c(e)},n.wbg.__wbg_self_fd00a1ef86d1b2ed=function(){return g(function(){const t=self.self;return c(t)},arguments)},n.wbg.__wbg_window_6f6e346d8bbd61d7=function(){return g(function(){const t=window.window;return c(t)},arguments)},n.wbg.__wbg_globalThis_3348936ac49df00a=function(){return g(function(){const t=globalThis.globalThis;return c(t)},arguments)},n.wbg.__wbg_global_67175caf56f55ca9=function(){return g(function(){const t=global.global;return c(t)},arguments)},n.wbg.__wbindgen_is_undefined=function(t){return i(t)===void 0},n.wbg.__wbg_buffer_34f5ec9f8a838ba0=function(t){const e=i(t).buffer;return c(e)},n.wbg.__wbg_new_cda198d9dbc6d7ea=function(t){const e=new Uint8Array(i(t));return c(e)},n.wbg.__wbg_set_1a930cfcda1a8067=function(t,e,r){i(t).set(i(e),r>>>0)},n.wbg.__wbg_length_51f19f73d6d9eff3=function(t){return i(t).length},n.wbg.__wbg_newwithlength_66e5530e7079ea1b=function(t){const e=new Uint8Array(t>>>0);return c(e)},n.wbg.__wbg_subarray_270ff8dd5582c1ac=function(t,e,r){const o=i(t).subarray(e>>>0,r>>>0);return c(o)},n.wbg.__wbindgen_throw=function(t,e){throw new Error(w(t,e))},n.wbg.__wbindgen_memory=function(){const t=_.memory;return c(t)},n}function P(n,t){return _=n.exports,j.__wbindgen_wasm_module=t,S=new Int32Array,h=new Uint8Array,_}async function j(n){typeof n>"u"&&(n=new URL("/stacklands-combat-simulator/assets/stacklands_combat_simulator_bg.ccab27af.wasm",self.location));const t=N();(typeof n=="string"||typeof Request=="function"&&n instanceof Request||typeof URL=="function"&&n instanceof URL)&&(n=fetch(n));const{instance:e,module:r}=await D(await n,t);return P(e,r)}const V=j();let y=!1;const T=n=>{postMessage(n)},A=1e3,q=(n,t)=>{n.iters+=t.iters,n.wins+=t.wins,n.total_length+=t.total_length,n.longest=Math.max(n.longest,t.longest);for(const[e,r]of t.enemy_hp.entries())n.enemy_hp[e]+=r;for(const[e,r]of t.village_survivors.entries())n.village_survivors[e]+=r},U=(n,t)=>{const e=(a,s)=>({...x(a,O(s.villagerSetup),O(s.enemySetup),s.monthStart,s.monthLength),...s}),r=t/Math.ceil(n.iterations/A),o=e(Math.min(n.iterations,1e3),n);T({type:"progress",progress:r,newResult:o});for(let a=A;a<n.iterations;a+=A){const s=e(a>n.iterations?a-n.iterations:A,n);q(o,s),T({type:"progress",progress:r,newResult:o,replace:!0})}return o},O=n=>{const t=[];for(const e of n)for(let r=0;r<e.count;r++)t.push(e);return t};function*R(n,t,e=0){for(;e<n.length;e++){const r=n[e];if(r.vary){for(r.count=r.min_count;r.count<=r.max_count;r.count++)for(const o of R(n,t,e+1))yield o;return}}for(;e-n.length<t.length;e++){const r=t[e-n.length];if(r.vary){for(r.count=r.min_count;r.count<=r.max_count;r.count++)for(const o of R(n,t,e+1))yield o;return}}yield}const z=async(n,t,e)=>{n.monthStart=0;const r=e/Math.floor(n.monthLength/t),o=U(n,r),a=Math.max(t,t*Math.floor((n.monthLength-o.longest)/t)),s=e-r,f=(n.monthLength-a)/t,u=s/f;for(n.monthStart=a;n.monthStart<n.monthLength&&(await k(),!!y);n.monthStart+=t)U(n,u)},B=async(n,t,e)=>{if(await V,y=!0,t||n.enemySetup.some(r=>r.vary)||n.villagerSetup.some(r=>r.vary)){const r=I(n.villagerSetup)*I(n.enemySetup),o=100/r;for(const a of R(n.villagerSetup,n.enemySetup)){if(await k(),!y)break;t?await z(n,e,o):U(n,o)}}else U(n,100);T({type:"done"}),y=!1};onmessage=n=>{const t=n.data;switch(t.type){case"cancel":y=!1,T({type:"cancelled"});break;case"simulate":B(t.setup,t.findMonthStart,t.findMonthStartStep);break}}})();
